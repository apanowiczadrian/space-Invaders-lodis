<!DOCTYPE html>
<html>
  <head>
    <title>spaceInv</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="assets/spaceship.png">
    <meta name="theme-color" content="#000000">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&family=Russo+One&display=swap" rel="stylesheet">

    <!-- iOS/Android Full-Screen and Viewport Control -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="js/p5.min.js"></script>

    <!-- Start Menu Logic (loaded before sketch.js) -->
    <script>
      // Global variable to store player data from HTML form
      window.playerDataFromMenu = null;
      window.isMenuReady = false;

      // Load saved player data from localStorage on page load
      document.addEventListener('DOMContentLoaded', function() {
        const nickInput = document.getElementById('nick-input');
        const emailInput = document.getElementById('email-input');

        // Load saved player data
        try {
          const saved = localStorage.getItem('spaceInvPlayerData');
          if (saved) {
            const data = JSON.parse(saved);
            if (data.nick) nickInput.value = data.nick;
            if (data.email) emailInput.value = data.email;
          }
        } catch (e) {
          console.error('Error loading player data:', e);
        }

        // Form submission handler
        const form = document.getElementById('start-form');
        const errorMessage = document.getElementById('error-message');

        function startGame() {
          const nick = nickInput.value.trim();
          const email = emailInput.value.trim();

          // Validation
          if (!nick) {
            errorMessage.textContent = 'Nick jest wymagany!';
            return;
          }

          if (nick.length < 2) {
            errorMessage.textContent = 'Nick musi mieƒá min. 2 znaki!';
            return;
          }

          if (!email) {
            errorMessage.textContent = 'Email/has≈Ço jest wymagane!';
            return;
          }

          // Clear error
          errorMessage.textContent = '';

          // Save to localStorage
          try {
            localStorage.setItem('spaceInvPlayerData', JSON.stringify({
              nick: nick,
              email: email
            }));
          } catch (e) {
            console.error('Error saving player data:', e);
          }

          // Store player data for game
          window.playerDataFromMenu = {
            nick: nick,
            email: email
          };

          // Hide start menu
          document.getElementById('start-menu').style.display = 'none';

          // Check if mobile device
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || ('ontouchstart' in window);
          const isStandalone = window.matchMedia('(display-mode: fullscreen)').matches || window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

          if (isMobile && !isStandalone) {
            // MOBILE & NOT IN PWA: Show PWA install screen
            document.getElementById('pwa-install-screen').style.display = 'flex';
            window.initPWAPrompt();
          } else {
            // DESKTOP OR ALREADY IN PWA: Start game directly
            startGameFromPWA();
          }
        }

        // Form submit handler (works for both Enter key and button click)
        form.addEventListener('submit', function(e) {
          e.preventDefault(); // Prevent page reload
          startGame();
        });

        // Auto-focus on nick input for desktop
        if (window.innerWidth > 768) {
          setTimeout(() => nickInput.focus(), 100);
        }
      });
    </script>

    <!-- Use type="module" for ES6 module support -->
    <script type="module" src="js/sketch.js"></script>

    <style>
  html, body {
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden;
    width: 100%;
    height: 100%;
    background-color: #000; /* Black background for the page */
  }

        canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100; /* Below menu overlay (which is z-index: 1000) */

            /* Prevent iOS text selection/callout behaviors */
            -webkit-user-select: none; /* Safari */
            user-select: none;
            -webkit-touch-callout: none; /* iOS */

            /* Crisp rendering and disable touch actions */
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            touch-action: none;

            /* Allow clicks to pass through when hidden */
            pointer-events: auto;
        }

        canvas[style*="display: none"] {
            pointer-events: none !important;
            z-index: -1 !important; /* Move completely behind when hidden */
        }

        /* Game Ready State - controls canvas visibility via class instead of inline styles */
        canvas {
            display: none; /* Hidden by default */
        }

        canvas.game-ready {
            display: block !important; /* Show when game is ready */
        }

        /* Portrait Warning Overlay - shown via JavaScript when portrait detected */
        #portrait-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a0a2e 0%, #0f0519 100%);
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
        }

        #portrait-warning.active {
            display: flex;
        }

        .rotation-icon {
            font-size: 80px;
            margin-bottom: 30px;
            animation: rotatePhone 2s ease-in-out infinite;
        }

        @keyframes rotatePhone {
            0%, 100% {
                transform: rotate(0deg);
            }
            50% {
                transform: rotate(90deg);
            }
        }

        .portrait-title {
            font-size: 32px;
            font-weight: 700;
            color: #00ffff;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .portrait-text {
            font-size: 18px;
            color: #ffffff;
            text-align: center;
            max-width: 80%;
            line-height: 1.6;
            opacity: 0.9;
        }
</style>

  </head>
  <body>
    <!-- Portrait Warning Overlay (JavaScript-controlled) -->
    <div id="portrait-warning">
      <div class="rotation-icon">üì±</div>
      <h2 class="portrait-title">Obr√≥ƒá UrzƒÖdzenie</h2>
      <p class="portrait-text">Ta gra wymaga orientacji poziomej (landscape)</p>
    </div>

    <!-- HTML Start Menu (Native Mobile Keyboard Support) -->
    <div id="start-menu" class="menu-overlay">
      <div class="menu-container">
        <h1 class="menu-title">LODIS - GALAGA</h1>
        

      </br>
        <!-- Form -->
        <form id="start-form" class="menu-form">
          <div class="form-row">
            <label for="nick-input">Nick:</label>
            <input
              id="nick-input"
              type="text"
              placeholder="Tw√≥j nick..."
              required
              minlength="2"
              maxlength="20"
              autocomplete="off"
              autocapitalize="off"
              spellcheck="false"
            >
          </div>

          <div class="form-row">
            <label for="email-input">Kontakt / Has≈Ço:</label>
            <input
              id="email-input"
              type="text"
              placeholder="email tylko do kontatktu"
              maxlength="40"
              autocomplete="off"
              autocapitalize="off"
            >
          </div>

          <p class="email-hint">Podaj Email albo has≈Ço do odebrania nagrody</p>

          <div class="error-message" id="error-message"></div>

          <button type="submit" id="start-button" class="start-button">START GAME</button>
        </form>
      </div>
    </div>

    <!-- PWA Install Screen (pokazuje siƒô po wprowadzeniu nicku) -->
    <div id="pwa-install-screen" class="menu-overlay" style="display: none;">
      <div class="menu-container">
        <h1 class="menu-title">üì± INSTALACJA GRY</h1>

        <!-- Android: Manual instructions -->
        <div id="pwa-android" style="display: none;">
          <div class="pwa-info">
            <ol class="pwa-instructions">
              <li>
                <span class="pwa-step-icon">1Ô∏è‚É£</span>
                <span>Naci≈õnij przycisk <strong>"Menu"</strong> -> trzy kropki w prawym g√≥rnym rogu przeglƒÖdarki</span>
              </li>
              <li>
                <span class="pwa-step-icon">2Ô∏è‚É£</span>
                <span>Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong>, lub szukaj czego≈õ w stylu <strong>"Install app"</strong></span>
              </li>
              <li>
                <span class="pwa-step-icon">‚ÅâÔ∏è</span>
                <span>Jest to potrzebne ≈ºeby <strong>gra</strong> by≈Ça na pe≈Çnym ekranie, <strong>inaczej nie zadzia≈Ça.</strong> to mechanizm "PWA"</span>
              </li>
              <li>
                <span class="pwa-step-icon">‚ö†Ô∏è</span>
                <span> U≈ºyj <strong>innej przeglƒÖdarki(np. chrome)</strong> jak nie dzia≈Ça <strong>dodanie do ekranu</strong></span>
              </li>
            </ol>
          </div>
          <div id="android-error-message" class="pwa-error-message" style="display: none;"></div>
          <button id="android-done-button" class="start-button">
            ‚úÖ ZROBI≈ÅEM, ROZPOCZNIJ GRƒò
          </button>
        </div>

        <!-- iOS: Manual instructions -->
        <div id="pwa-ios" style="display: none;">
          <div class="pwa-info">
            <p>üì± Aby zainstalowaƒá grƒô na iOS:</p>
            <ol class="pwa-instructions">
              <li>
                <span class="pwa-step-icon">1Ô∏è‚É£</span>
                <span>Naci≈õnij przycisk <strong>"Udostƒôpnij"</strong> üì§<br>(na dole ekranu)</span>
              </li>
              <li>
                <span class="pwa-step-icon">2Ô∏è‚É£</span>
                <span>Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong> ‚ûï</span>
              </li>
              <li>
                <span class="pwa-step-icon">3Ô∏è‚É£</span>
                <span>Potwierd≈∫ <strong>"Dodaj"</strong> ‚úÖ</span>
              </li>
            </ol>
          </div>
          <div id="ios-error-message" class="pwa-error-message" style="display: none;"></div>
          <button id="ios-done-button" class="start-button">
            ‚úÖ ZROBI≈ÅEM, ROZPOCZNIJ GRƒò
          </button>
        </div>

      </div>
    </div>

    <script>
      // Prevent pinch-to-zoom
      document.addEventListener('touchmove', function (event) {
        if (event.scale !== 1) {
          event.preventDefault();
        }
      }, { passive: false });

      // Prevent double-tap-to-zoom (except on form elements)
      var lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        var now = (new Date()).getTime();
        var target = event.target;

        // Don't prevent default on form elements
        var isFormElement = target.tagName === 'INPUT' ||
                           target.tagName === 'BUTTON' ||
                           target.tagName === 'TEXTAREA' ||
                           target.tagName === 'SELECT' ||
                           target.closest('.menu-overlay');

        if (now - lastTouchEnd <= 300 && !isFormElement) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
    </script>

    <!-- PWA Install Logic -->
    <script>
      // 3-click fallback mechanism state
      let pwaClickAttempts = 0;
      const MAX_ATTEMPTS = 3;

      window.initPWAPrompt = function() {
        const androidDiv = document.getElementById('pwa-android');
        const iosDiv = document.getElementById('pwa-ios');

        // Check if already running in standalone mode (PWA already installed)
        const isStandalone = window.matchMedia('(display-mode: fullscreen)').matches ||
                            window.matchMedia('(display-mode: standalone)').matches ||
                            window.navigator.standalone === true;

        if (isStandalone) {
          // Already installed - start game directly (no intermediate screen needed)
          startGameFromPWA();
          return;
        }

        // Detect iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        if (isIOS) {
          // iOS - show manual instructions
          iosDiv.style.display = 'block';
          document.getElementById('ios-done-button').addEventListener('click', handlePWADoneClick);
        } else {
          // Android - show manual instructions
          androidDiv.style.display = 'block';
          document.getElementById('android-done-button').addEventListener('click', handlePWADoneClick);
        }
      };

      function handlePWADoneClick(event) {
        // Determine which button was clicked
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const doneButton = isIOS ?
          document.getElementById('ios-done-button') :
          document.getElementById('android-done-button');

        // Check if button is in cooldown (disabled)
        if (doneButton.disabled) {
          return; // Ignore clicks during cooldown
        }

        // Check if PWA is installed
        const isStandalone = window.matchMedia('(display-mode: fullscreen)').matches ||
                            window.matchMedia('(display-mode: standalone)').matches ||
                            window.navigator.standalone === true;

        if (isStandalone) {
          // PWA detected - start game (no cooldown needed)
          startGameFromPWA();
          return;
        }

        // PWA not detected - increment attempt counter
        pwaClickAttempts++;

        // Get error message container
        const errorContainer = isIOS ?
          document.getElementById('ios-error-message') :
          document.getElementById('android-error-message');

        // Show error message based on attempt count
        if (pwaClickAttempts === 1) {
          errorContainer.textContent = '‚ùå PWA nie wykryto! Sprawd≈∫ czy uruchomi≈Çe≈õ grƒô z ekranu g≈Ç√≥wnego.';
          errorContainer.style.display = 'block';
        } else if (pwaClickAttempts === 2) {
          errorContainer.textContent = '‚ùå Nadal brak PWA! Upewnij siƒô ≈ºe otworzy≈Çe≈õ ikonƒô z ekranu g≈Ç√≥wnego.';
          errorContainer.style.display = 'block';
        } else if (pwaClickAttempts >= MAX_ATTEMPTS) {
          // After 3 attempts - change button to fallback mode
          errorContainer.style.display = 'none';
          doneButton.textContent = '‚ö†Ô∏è GRAJ BEZ PWA (niestabilna wersja)';
          doneButton.style.background = 'rgb(200, 80, 50)';
          doneButton.style.borderColor = 'rgb(220, 100, 80)';

          // Remove old listener and add new one that starts game immediately
          doneButton.removeEventListener('click', handlePWADoneClick);
          doneButton.addEventListener('click', startGameFromPWA);
          return; // No cooldown for final fallback state
        }

        // Apply 3-second cooldown (only for error states)
        doneButton.disabled = true;
        setTimeout(() => {
          doneButton.disabled = false;
        }, 3000);
      }

      function startGameFromPWA() {
        // Hide PWA screen
        document.getElementById('pwa-install-screen').style.display = 'none';

        // Show canvas via CSS class (not inline style)
        const canvas = document.querySelector('canvas');
        if (canvas) {
          canvas.classList.add('game-ready');
        }

        // Trigger startGame event for sketch.js
        window.dispatchEvent(new CustomEvent('startGame', {
          detail: window.playerDataFromMenu
        }));
      }
    </script>

    <!-- Service Worker Registration (Critical for PWA Install) -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
              console.log('‚úÖ Service Worker registered successfully:', registration.scope);
            })
            .catch((error) => {
              console.error('‚ùå Service Worker registration failed:', error);
            });
        });
      } else {
        console.warn('‚ö†Ô∏è Service Worker not supported in this browser');
      }
    </script>
  </body>
</html>