<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>LODIS GALAGA - Instalacja PWA</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared/styles.css">

    <!-- PWA-specific styles (scrolling fix) -->
    <style>
        /* FIX: Enable scrolling in landscape on mobile */
        .menu-container {
            max-height: 85vh; /* Limit height to enable scroll */
            overflow-y: auto; /* Enable vertical scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
        }

        .pwa-instructions {
            /* Compact font for mobile landscape */
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Sticky button always visible at bottom */
        .pwa-done-button {
            position: sticky;
            bottom: 10px;
            margin-top: 20px;
            background: #4CAF50;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* Compact layout for very small screens (landscape mobile) */
        @media (max-height: 500px) {
            .pwa-instructions li {
                padding: 8px; /* Reduce padding */
            }

            .menu-container {
                max-height: 90vh; /* More space */
                padding: 20px;
            }

            .menu-title {
                font-size: 22px;
                margin-bottom: 10px;
            }

            .pwa-info p {
                font-size: 13px;
            }
        }
    </style>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/spaceship.png">
    <meta name="theme-color" content="#000000">

    <!-- iOS/Android Full-Screen and Viewport Control -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <!-- PWA Install Screen -->
    <div id="pwa-install-screen" class="menu-overlay">
        <div class="menu-container">
            <h1 class="menu-title">üì± INSTALACJA GRY</h1>

            <!-- Android: Manual instructions -->
            <div id="pwa-android" style="display: none;">
                <div class="pwa-info">
                    <ol class="pwa-instructions">
                        <li>
                            <span class="pwa-step-icon">1Ô∏è‚É£</span>
                            <span>Naci≈õnij przycisk <strong>"Menu"</strong> -> trzy kropki w prawym g√≥rnym rogu przeglƒÖdarki</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">2Ô∏è‚É£</span>
                            <span>Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong>, lub szukaj czego≈õ w stylu <strong>"Install app"</strong></span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">‚ÅâÔ∏è</span>
                            <span>Jest to potrzebne ≈ºeby <strong>gra</strong> by≈Ça na pe≈Çnym ekranie, <strong>inaczej nie zadzia≈Ça.</strong> to mechanizm "PWA"</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">‚ö†Ô∏è</span>
                            <span> U≈ºyj <strong>innej przeglƒÖdarki(np. chrome)</strong> jak nie dzia≈Ça <strong>dodanie do ekranu</strong></span>
                        </li>
                    </ol>
                </div>
                <button id="android-done-button" class="start-button pwa-done-button">
                    Uruchomiƒá grƒô bez PWA?
                </button>
            </div>

            <!-- Opera Mobile: Manual instructions -->
            <div id="pwa-opera" style="display: none;">
                <div class="pwa-info">
                    <p>üì± Aby zainstalowaƒá grƒô na Opera Mobile:</p>
                    <ol class="pwa-instructions">
                        <li>
                            <span class="pwa-step-icon">1Ô∏è‚É£</span>
                            <span>Kliknij <strong>3 kropki</strong> w prawym g√≥rnym rogu przeglƒÖdarki</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">2Ô∏è‚É£</span>
                            <span>Wybierz <strong>"Dodaj do"</strong></span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">3Ô∏è‚É£</span>
                            <span>Wybierz <strong>"Ekran g≈Ç√≥wny"</strong></span>
                        </li>
                    </ol>
                </div>
                <button id="opera-done-button" class="start-button pwa-done-button">
                    Uruchomiƒá grƒô bez PWA?
                </button>
            </div>

            <!-- iOS: Manual instructions -->
            <div id="pwa-ios" style="display: none;">
                <div class="pwa-info">
                    <p>üì± Aby zainstalowaƒá grƒô na iOS:</p>
                    <ol class="pwa-instructions">
                        <li>
                            <span class="pwa-step-icon">1Ô∏è‚É£</span>
                            <span>Naci≈õnij przycisk <strong>"Udostƒôpnij"</strong> üì§<br>(na dole ekranu)</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">2Ô∏è‚É£</span>
                            <span>Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong> ‚ûï</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">3Ô∏è‚É£</span>
                            <span>Potwierd≈∫ <strong>"Dodaj"</strong> ‚úÖ</span>
                        </li>
                    </ol>
                </div>
                <button id="ios-done-button" class="start-button pwa-done-button">
                    Uruchomiƒá grƒô bez PWA?
                </button>
            </div>
        </div>
    </div>

    <!-- Touch/Zoom Prevention -->
    <script>
        // Prevent pinch-to-zoom
        document.addEventListener('touchmove', function (event) {
            if (event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });

        // Prevent double-tap-to-zoom (except on form elements)
        var lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            var now = (new Date()).getTime();
            var target = event.target;

            // Don't prevent default on form elements
            var isFormElement = target.tagName === 'INPUT' ||
                               target.tagName === 'BUTTON' ||
                               target.tagName === 'TEXTAREA' ||
                               target.tagName === 'SELECT' ||
                               target.closest('.menu-overlay');

            if (now - lastTouchEnd <= 300 && !isFormElement) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>

    <!-- Main Logic -->
    <script type="module">
        import { isStandaloneMode, isIOS, isAndroid, isOpera, isMobileDevice } from './shared/pwa-detection.js';
        import { redirectToGame, redirectToMenu } from './shared/navigation.js';
        import { hasPlayerData } from './shared/player-data.js';

        // Capture native PWA install prompt (Chromium browsers: Chrome, Opera, Edge, Samsung Internet)
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome's default mini-infobar
            e.preventDefault();
            // Save the event for later use
            deferredPrompt = e;
            console.log('‚úÖ PWA install prompt captured - ready to trigger on demand');
        });

        // Listen for successful PWA installation
        window.addEventListener('appinstalled', (e) => {
            console.log('‚úÖ PWA installed successfully!');
            deferredPrompt = null;
            // Desktop: PWA opens automatically
            // Mobile: User needs to manually open the installed icon
        });

        // Initialize PWA prompt
        document.addEventListener('DOMContentLoaded', function() {
            initPWAPrompt();

            // Auto-trigger native install prompt after 3s (Chromium browsers only)
            setTimeout(() => {
                if (deferredPrompt && !isStandaloneMode()) {
                    console.log('üöÄ Auto-triggering native PWA install prompt after 3s...');
                    triggerNativeInstallPrompt();
                }
            }, 3000);
        });

        function initPWAPrompt() {
            const androidDiv = document.getElementById('pwa-android');
            const operaDiv = document.getElementById('pwa-opera');
            const iosDiv = document.getElementById('pwa-ios');

            // Check if already running in standalone mode (PWA already installed)
            if (isStandaloneMode()) {
                // Already installed - start game directly
                console.log('‚úÖ PWA already installed, redirecting to game');
                redirectToGame();
                return;
            }

            if (isIOS()) {
                // iOS - show manual instructions
                iosDiv.style.display = 'block';
                document.getElementById('ios-done-button').addEventListener('click', handlePWADoneClick);
            } else if (isOpera() && isMobileDevice()) {
                // Opera Mobile - show Opera-specific instructions
                operaDiv.style.display = 'block';
                document.getElementById('opera-done-button').addEventListener('click', handlePWADoneClick);

                // Trigger native Opera install prompt if available (Opera is Chromium-based)
                if (deferredPrompt) {
                    triggerNativeInstallPrompt();
                }
            } else if (isAndroid()) {
                // Android - show manual instructions
                androidDiv.style.display = 'block';
                document.getElementById('android-done-button').addEventListener('click', handlePWADoneClick);

                // Trigger native Chrome install prompt if available
                if (deferredPrompt) {
                    triggerNativeInstallPrompt();
                }
            } else {
                // Generic mobile (rare case)
                androidDiv.style.display = 'block';
                document.getElementById('android-done-button').addEventListener('click', handlePWADoneClick);
            }
        }

        async function triggerNativeInstallPrompt() {
            if (!deferredPrompt) {
                return;
            }

            try {
                // Show native install prompt
                console.log('üöÄ Triggering native PWA install prompt...');
                deferredPrompt.prompt();

                // Wait for user response
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`üë§ User response: ${outcome}`);

                if (outcome === 'accepted') {
                    console.log('‚úÖ PWA installation accepted');
                    console.log('‚ÑπÔ∏è Desktop: PWA will auto-open | Mobile: Find app icon on home screen');
                } else {
                    console.log('‚ùå PWA installation dismissed');
                }

                // Clear the deferredPrompt (can only be used once)
                deferredPrompt = null;
            } catch (error) {
                console.error('Error triggering install prompt:', error);
            }
        }

        function handlePWADoneClick(event) {
            // Determine which button was clicked
            const isIOSDevice = isIOS();
            const isOperaDevice = isOpera() && isMobileDevice();

            let doneButton;
            if (isIOSDevice) {
                doneButton = document.getElementById('ios-done-button');
            } else if (isOperaDevice) {
                doneButton = document.getElementById('opera-done-button');
            } else {
                doneButton = document.getElementById('android-done-button');
            }

            // Check if button is in cooldown (disabled)
            if (doneButton.disabled) {
                return; // Ignore clicks during cooldown
            }

            // Check current button state
            const currentText = doneButton.textContent.trim();

            if (currentText === 'Uruchomiƒá grƒô bez PWA?') {
                // State 1 ‚Üí State 2: Apply cooldown and change to second state
                doneButton.disabled = true;

                setTimeout(() => {
                    doneButton.textContent = 'Grajƒô w niestabilnƒÖ grƒô';
                    doneButton.style.background = 'rgb(200, 80, 50)';
                    doneButton.style.borderColor = 'rgb(220, 100, 80)';
                    doneButton.disabled = false;
                }, 2000); // 2s cooldown
            } else if (currentText === 'Grajƒô w niestabilnƒÖ grƒô') {
                // State 2 ‚Üí Launch game
                sessionStorage.setItem('pwaScreenSeen', 'true');

                if (hasPlayerData()) {
                    console.log('‚Üí Launching game without PWA, player data exists');
                    redirectToGame();
                } else {
                    console.log('‚Üí Launching game without PWA, no player data');
                    redirectToMenu();
                }
            }
        }
    </script>
</body>
</html>
