<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>LODIS GALAGA - Instalacja PWA</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared/styles.css">

    <!-- PWA-specific styles (scrolling fix) -->
    <style>
        /* FIX: Enable scrolling in landscape on mobile */
        .menu-container {
            max-height: 85vh; /* Limit height to enable scroll */
            overflow-y: auto; /* Enable vertical scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
        }

        .pwa-instructions {
            /* Compact font for mobile landscape */
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Sticky button always visible at bottom */
        .pwa-done-button {
            position: sticky;
            bottom: 10px;
            margin-top: 20px;
            background: #4CAF50;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* Compact layout for very small screens (landscape mobile) */
        @media (max-height: 500px) {
            .pwa-instructions li {
                padding: 8px; /* Reduce padding */
            }

            .menu-container {
                max-height: 90vh; /* More space */
                padding: 20px;
            }

            .menu-title {
                font-size: 22px;
                margin-bottom: 10px;
            }

            .pwa-info p {
                font-size: 13px;
            }
        }
    </style>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/spaceship.png">
    <meta name="theme-color" content="#000000">

    <!-- iOS/Android Full-Screen and Viewport Control -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <!-- PWA Install Screen -->
    <div id="pwa-install-screen" class="menu-overlay">
        <div class="menu-container">
            <h1 class="menu-title">üì± INSTALACJA GRY</h1>

            <!-- Android: Manual instructions -->
            <div id="pwa-android" style="display: none;">
                <div class="pwa-info">
                    <ol class="pwa-instructions">
                        <li>
                            <span class="pwa-step-icon">1Ô∏è‚É£</span>
                            <span>Naci≈õnij przycisk <strong>"Menu"</strong> -> trzy kropki w prawym g√≥rnym rogu przeglƒÖdarki</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">2Ô∏è‚É£</span>
                            <span>Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong>, lub szukaj czego≈õ w stylu <strong>"Install app"</strong></span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">‚ÅâÔ∏è</span>
                            <span>Jest to potrzebne ≈ºeby <strong>gra</strong> by≈Ça na pe≈Çnym ekranie, <strong>inaczej nie zadzia≈Ça.</strong> to mechanizm "PWA"</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">‚ö†Ô∏è</span>
                            <span> U≈ºyj <strong>innej przeglƒÖdarki(np. chrome)</strong> jak nie dzia≈Ça <strong>dodanie do ekranu</strong></span>
                        </li>
                    </ol>
                </div>
                <div id="android-error-message" class="pwa-error-message" style="display: none;"></div>
                <button id="android-done-button" class="start-button pwa-done-button">
                    ‚úÖ ZROBI≈ÅEM, ROZPOCZNIJ GRƒò
                </button>
            </div>

            <!-- iOS: Manual instructions -->
            <div id="pwa-ios" style="display: none;">
                <div class="pwa-info">
                    <p>üì± Aby zainstalowaƒá grƒô na iOS:</p>
                    <ol class="pwa-instructions">
                        <li>
                            <span class="pwa-step-icon">1Ô∏è‚É£</span>
                            <span>Naci≈õnij przycisk <strong>"Udostƒôpnij"</strong> üì§<br>(na dole ekranu)</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">2Ô∏è‚É£</span>
                            <span>Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong> ‚ûï</span>
                        </li>
                        <li>
                            <span class="pwa-step-icon">3Ô∏è‚É£</span>
                            <span>Potwierd≈∫ <strong>"Dodaj"</strong> ‚úÖ</span>
                        </li>
                    </ol>
                </div>
                <div id="ios-error-message" class="pwa-error-message" style="display: none;"></div>
                <button id="ios-done-button" class="start-button pwa-done-button">
                    ‚úÖ ZROBI≈ÅEM, ROZPOCZNIJ GRƒò
                </button>
            </div>
        </div>
    </div>

    <!-- Touch/Zoom Prevention -->
    <script>
        // Prevent pinch-to-zoom
        document.addEventListener('touchmove', function (event) {
            if (event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });

        // Prevent double-tap-to-zoom (except on form elements)
        var lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            var now = (new Date()).getTime();
            var target = event.target;

            // Don't prevent default on form elements
            var isFormElement = target.tagName === 'INPUT' ||
                               target.tagName === 'BUTTON' ||
                               target.tagName === 'TEXTAREA' ||
                               target.tagName === 'SELECT' ||
                               target.closest('.menu-overlay');

            if (now - lastTouchEnd <= 300 && !isFormElement) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>

    <!-- Main Logic -->
    <script type="module">
        import { isStandaloneMode, isIOS, isAndroid } from './shared/pwa-detection.js';
        import { redirectToGame, redirectToMenu } from './shared/navigation.js';
        import { hasPlayerData } from './shared/player-data.js';

        // 3-click fallback mechanism state
        let pwaClickAttempts = 0;
        const MAX_ATTEMPTS = 3;

        // Capture native PWA install prompt (Android Chrome)
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome's default mini-infobar
            e.preventDefault();
            // Save the event for later use
            deferredPrompt = e;
            console.log('‚úÖ PWA install prompt captured - ready to trigger on demand');
        });

        // Listen for successful PWA installation
        window.addEventListener('appinstalled', (e) => {
            console.log('‚úÖ PWA installed successfully!');
            deferredPrompt = null;

            // Auto-start game after installation
            setTimeout(() => {
                redirectToGame();
            }, 500);
        });

        // Initialize PWA prompt
        document.addEventListener('DOMContentLoaded', function() {
            initPWAPrompt();
        });

        function initPWAPrompt() {
            const androidDiv = document.getElementById('pwa-android');
            const iosDiv = document.getElementById('pwa-ios');

            // Check if already running in standalone mode (PWA already installed)
            if (isStandaloneMode()) {
                // Already installed - start game directly
                console.log('‚úÖ PWA already installed, redirecting to game');
                redirectToGame();
                return;
            }

            if (isIOS()) {
                // iOS - show manual instructions
                iosDiv.style.display = 'block';
                document.getElementById('ios-done-button').addEventListener('click', handlePWADoneClick);
            } else if (isAndroid()) {
                // Android - show manual instructions
                androidDiv.style.display = 'block';
                document.getElementById('android-done-button').addEventListener('click', handlePWADoneClick);

                // Trigger native Chrome install prompt if available
                if (deferredPrompt) {
                    triggerNativeInstallPrompt();
                }
            } else {
                // Generic mobile (rare case)
                androidDiv.style.display = 'block';
                document.getElementById('android-done-button').addEventListener('click', handlePWADoneClick);
            }
        }

        async function triggerNativeInstallPrompt() {
            if (!deferredPrompt) {
                return;
            }

            try {
                // Show native install prompt
                console.log('üöÄ Triggering native PWA install prompt...');
                deferredPrompt.prompt();

                // Wait for user response
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`üë§ User response: ${outcome}`);

                if (outcome === 'accepted') {
                    console.log('‚úÖ PWA installation accepted');
                    // Hide error messages if any
                    document.getElementById('android-error-message').style.display = 'none';

                    // Wait a bit for installation to complete, then auto-start
                    setTimeout(() => {
                        redirectToGame();
                    }, 1000);
                } else {
                    console.log('‚ùå PWA installation dismissed');
                }

                // Clear the deferredPrompt (can only be used once)
                deferredPrompt = null;
            } catch (error) {
                console.error('Error triggering install prompt:', error);
            }
        }

        function handlePWADoneClick(event) {
            // Determine which button was clicked
            const isIOSDevice = isIOS();
            const doneButton = isIOSDevice ?
                document.getElementById('ios-done-button') :
                document.getElementById('android-done-button');

            // Check if button is in cooldown (disabled)
            if (doneButton.disabled) {
                return; // Ignore clicks during cooldown
            }

            // Mark that user has seen PWA screen (session flag to prevent redirect loop)
            sessionStorage.setItem('pwaScreenSeen', 'true');

            // Check if PWA is installed
            if (isStandaloneMode()) {
                // PWA detected - check localStorage and redirect accordingly
                if (hasPlayerData()) {
                    console.log('‚Üí PWA detected, player data exists ‚Üí redirecting to game');
                    redirectToGame();
                } else {
                    console.log('‚Üí PWA detected, no player data ‚Üí redirecting to menu');
                    redirectToMenu();
                }
                return;
            }

            // PWA not detected - increment attempt counter
            pwaClickAttempts++;

            // Get error message container
            const errorContainer = isIOSDevice ?
                document.getElementById('ios-error-message') :
                document.getElementById('android-error-message');

            // Show error message based on attempt count
            if (pwaClickAttempts === 1) {
                errorContainer.textContent = '‚ùå PWA nie wykryto! Sprawd≈∫ czy uruchomi≈Çe≈õ grƒô z ekranu g≈Ç√≥wnego.';
                errorContainer.style.display = 'block';
            } else if (pwaClickAttempts === 2) {
                errorContainer.textContent = '‚ùå Nadal brak PWA! Upewnij siƒô ≈ºe otworzy≈Çe≈õ ikonƒô z ekranu g≈Ç√≥wnego.';
                errorContainer.style.display = 'block';
            } else if (pwaClickAttempts >= MAX_ATTEMPTS) {
                // After 3 attempts - change button to fallback mode
                errorContainer.style.display = 'none';
                doneButton.textContent = '‚ö†Ô∏è GRAJ BEZ PWA (niestabilna wersja)';
                doneButton.style.background = 'rgb(200, 80, 50)';
                doneButton.style.borderColor = 'rgb(220, 100, 80)';

                // Remove old listener and add new one that checks localStorage
                doneButton.removeEventListener('click', handlePWADoneClick);
                doneButton.addEventListener('click', () => {
                    // Mark that user has seen PWA screen (session flag)
                    sessionStorage.setItem('pwaScreenSeen', 'true');

                    if (hasPlayerData()) {
                        console.log('‚Üí Fallback mode, player data exists ‚Üí redirecting to game');
                        redirectToGame();
                    } else {
                        console.log('‚Üí Fallback mode, no player data ‚Üí redirecting to menu');
                        redirectToMenu();
                    }
                });
                return; // No cooldown for final fallback state
            }

            // Apply 3-second cooldown (only for error states)
            doneButton.disabled = true;
            setTimeout(() => {
                doneButton.disabled = false;
            }, 3000);
        }
    </script>
</body>
</html>
